{
  "title": "RunConfig",
  "description": "Run configuration for Olive workflow.\n\nThis is the top-level configuration. It includes configurations for input model, systems, data,\nevaluators, engine, passes, and auto optimizer.",
  "type": "object",
  "properties": {
    "workflow_id": {
      "title": "Workflow Id",
      "description": "Workflow ID. If not provided, use the default ID 'default_workflow'.",
      "default": "default_workflow",
      "type": "string"
    },
    "azureml_client": {
      "title": "Azureml Client",
      "description": "AzureML client configuration. This client configuration will be used for all AzureML related resources in the workflow.",
      "allOf": [
        {
          "$ref": "#/definitions/AzureMLClientConfig"
        }
      ]
    },
    "input_model": {
      "title": "Input Model",
      "description": "Input model configuration.",
      "allOf": [
        {
          "$ref": "#/definitions/ModelConfig"
        }
      ]
    },
    "systems": {
      "title": "Systems",
      "description": "System configurations. Other fields such as engine and passes can refer to these systems by name.",
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/SystemConfig"
      }
    },
    "data_root": {
      "title": "Data Root",
      "description": "Root directory for data. If provided, all relative data paths in other configs will be resolved based on this root.",
      "type": "string"
    },
    "data_configs": {
      "title": "Data Configs",
      "description": "Data configurations. Each data config must have a unique name. Other fields such as engine, passes and evaluators can refer to these data configs by name. In auto-optimizer mode, only one data config is allowed.",
      "type": "array",
      "items": {
        "$ref": "#/definitions/DataConfig"
      }
    },
    "evaluators": {
      "title": "Evaluators",
      "description": "Evaluator configurations. Other fields such as engine and passes can refer to these evaluators by name.",
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/OliveEvaluatorConfig"
      }
    },
    "engine": {
      "title": "Engine",
      "description": "Engine configuration. If not provided, the workflow uses the default engine configuration which runs in no-search or auto-optimizer mode based on whether passes field is provided.",
      "allOf": [
        {
          "$ref": "#/definitions/RunEngineConfig"
        }
      ]
    },
    "passes": {
      "title": "Passes",
      "description": "Pass configurations.",
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/RunPassConfig"
      }
    },
    "pass_flows": {
      "title": "Pass Flows",
      "description": "Pass flows. Each member must be a list of pass names from `passes` field. If provided, each flow will be run sequentially. If not provided, all passes will be run as a single flow in the order of `passes` field.",
      "type": "array",
      "items": {
        "type": "array",
        "items": {
          "type": "string"
        }
      }
    },
    "auto_optimizer_config": {
      "title": "Auto Optimizer Config",
      "description": "Auto optimizer configuration. Only valid when passes field is empty or not provided.",
      "allOf": [
        {
          "$ref": "#/definitions/AutoOptimizerConfig"
        }
      ]
    }
  },
  "required": [
    "input_model"
  ],
  "definitions": {
    "AzureMLClientConfig": {
      "title": "AzureMLClientConfig",
      "description": "Configuration for AzureMLClient.\n\nThis class is used to create an MLClient instance for AzureML operations.\nSome fields like `read_timeout`, `max_operation_retries`, `operation_retry_interval` are used to control the\nbehavior of azureml operations like resource creation or download.",
      "type": "object",
      "properties": {
        "subscription_id": {
          "title": "Subscription Id",
          "description": "Azure subscription id. Required if aml_config_path is not provided.",
          "type": "string"
        },
        "resource_group": {
          "title": "Resource Group",
          "description": "Azure resource group. Required if aml_config_path is not provided.",
          "type": "string"
        },
        "workspace_name": {
          "title": "Workspace Name",
          "description": "Azure workspace name. Required if aml_config_path is not provided.",
          "type": "string"
        },
        "aml_config_path": {
          "title": "Aml Config Path",
          "description": "Path to AzureML config file. If provided, other fields are ignored.",
          "type": "string"
        },
        "read_timeout": {
          "title": "Read Timeout",
          "description": "Read timeout in seconds for HTTP requests.",
          "default": 60,
          "type": "integer"
        },
        "max_operation_retries": {
          "title": "Max Operation Retries",
          "description": "Max number of retries for AzureML operations like resource creation or download.",
          "default": 3,
          "type": "integer"
        },
        "operation_retry_interval": {
          "title": "Operation Retry Interval",
          "description": "Initial interval in seconds between retries for AzureML operations like resource creation or download. The interval doubles after each retry.",
          "default": 5,
          "type": "integer"
        },
        "default_auth_params": {
          "title": "Default Auth Params",
          "description": "Default auth config for AzureML client. Please refer to https://learn.microsoft.com/en-us/python/api/azure-identity/azure.identity.defaultazurecredential?view=azure-python#parameters for more details.",
          "type": "object"
        },
        "keyvault_name": {
          "title": "Keyvault Name",
          "description": "Name of the keyvault to use. If provided, the keyvault will be used to retrieve secrets.",
          "type": "string"
        }
      }
    },
    "ModelConfig": {
      "title": "ModelConfig",
      "description": "Input model config which will be used to create the model handler.\n\nFor example, the config looks like for llama2:\n\n.. code-block:: json\n\n    {\n        \"input_model\": {\n            \"type\": \"CompositePyTorchModel\",\n            \"config\": {\n                \"model_path\": \"llama_v2\",\n                \"generative\": False,\n                \"model_components\": [\n                    {\n                        \"name\": \"decoder_model\",\n                        \"type\": \"PyTorchModel\",\n                        \"config\": {\n                            \"model_script\": \"user_script.py\",\n                            \"io_config\": {\n                                \"input_names\": [\"tokens\", \"position_ids\", \"attn_mask\", //...],\n                                \"output_names\": [\"logits\", \"attn_mask_out\", //...],\n                                \"dynamic_axes\": {\n                                    \"tokens\": { \"0\": \"batch_size\", \"1\": \"seq_len\" },\n                                    \"position_ids\": { \"0\": \"batch_size\", \"1\": \"seq_len\" },\n                                    \"attn_mask\": { \"0\": \"batch_size\", \"1\": \"max_seq_len\" },\n                                    //...\n                                }\n                            },\n                            \"model_loader\": \"load_decoder_model\",\n                            \"dummy_inputs_func\": \"decoder_inputs\"\n                        }\n                    },\n                    {\n                        \"name\": \"decoder_with_past_model\",\n                        \"type\": \"PyTorchModel\",\n                        \"config\": {\n                            \"model_script\": \"user_script.py\",\n                            \"io_config\": {\n                                \"input_names\": [\"tokens_increment\", \"position_ids_increment\", \"attn_mask\", //...],\n                                \"output_names\": [\"logits\", \"attn_mask_out\", //...],\n                                \"dynamic_axes\": {\n                                    \"tokens_increment\": { \"0\": \"batch_size\", \"1\": \"seq_len_increment\" },\n                                    \"position_ids_increment\": { \"0\": \"batch_size\", \"1\": \"seq_len_increment\" },\n                                    \"attn_mask\": { \"0\": \"batch_size\", \"1\": \"max_seq_len\" },\n                                    //...\n                                }\n                            },\n                            \"model_loader\": \"load_decoder_with_past_model\",\n                            \"dummy_inputs_func\": \"decoder_with_past_inputs\"\n                        }\n                    }\n                ]\n            }\n        }\n    }",
      "type": "object",
      "properties": {
        "type": {
          "title": "Type",
          "description": "The type of the model handler.",
          "type": "string"
        },
        "config": {
          "title": "Config",
          "description": "The config for the model handler. Used to initialize the model handler.",
          "type": "object"
        }
      },
      "required": [
        "type",
        "config"
      ]
    },
    "SystemType": {
      "title": "SystemType",
      "description": "An enumeration.",
      "enum": [
        "Docker",
        "LocalSystem",
        "AzureML",
        "PythonEnvironment",
        "IsolatedORT"
      ],
      "type": "string"
    },
    "Device": {
      "title": "Device",
      "description": "An enumeration.",
      "enum": [
        "cpu",
        "cpu_spr",
        "gpu",
        "npu",
        "vpu",
        "intel_myriad"
      ],
      "type": "string"
    },
    "AcceleratorConfig": {
      "title": "AcceleratorConfig",
      "type": "object",
      "properties": {
        "device": {
          "title": "Device",
          "anyOf": [
            {
              "type": "string"
            },
            {
              "$ref": "#/definitions/Device"
            }
          ]
        },
        "execution_providers": {
          "title": "Execution Providers",
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "TargetUserConfig": {
      "title": "TargetUserConfig",
      "type": "object",
      "properties": {
        "accelerators": {
          "title": "Accelerators",
          "type": "array",
          "items": {
            "$ref": "#/definitions/AcceleratorConfig"
          }
        },
        "hf_token": {
          "title": "Hf Token",
          "type": "boolean"
        }
      }
    },
    "SystemConfig": {
      "title": "SystemConfig",
      "type": "object",
      "properties": {
        "type": {
          "$ref": "#/definitions/SystemType"
        },
        "config": {
          "$ref": "#/definitions/TargetUserConfig"
        }
      },
      "required": [
        "type"
      ]
    },
    "DataComponentConfig": {
      "title": "DataComponentConfig",
      "type": "object",
      "properties": {
        "type": {
          "title": "Type",
          "type": "string"
        },
        "params": {
          "title": "Params",
          "type": "object"
        }
      }
    },
    "DataConfig": {
      "title": "DataConfig",
      "type": "object",
      "properties": {
        "name": {
          "title": "Name",
          "type": "string"
        },
        "type": {
          "title": "Type",
          "default": "DataContainer",
          "type": "string"
        },
        "user_script": {
          "title": "User Script",
          "anyOf": [
            {
              "type": "string",
              "format": "path"
            },
            {
              "type": "string"
            }
          ]
        },
        "script_dir": {
          "title": "Script Dir",
          "anyOf": [
            {
              "type": "string",
              "format": "path"
            },
            {
              "type": "string"
            }
          ]
        },
        "load_dataset_config": {
          "$ref": "#/definitions/DataComponentConfig"
        },
        "pre_process_data_config": {
          "$ref": "#/definitions/DataComponentConfig"
        },
        "post_process_data_config": {
          "$ref": "#/definitions/DataComponentConfig"
        },
        "dataloader_config": {
          "$ref": "#/definitions/DataComponentConfig"
        }
      },
      "required": [
        "name"
      ]
    },
    "MetricType": {
      "title": "MetricType",
      "description": "An enumeration.",
      "enum": [
        "accuracy",
        "latency",
        "throughput",
        "custom"
      ],
      "type": "string"
    },
    "AccuracySubType": {
      "title": "AccuracySubType",
      "description": "An enumeration.",
      "enum": [
        "accuracy_score",
        "f1_score",
        "precision",
        "recall",
        "auroc",
        "perplexity"
      ],
      "type": "string"
    },
    "LatencyMetricConfig": {
      "title": "LatencyMetricConfig",
      "type": "object",
      "properties": {
        "warmup_num": {
          "title": "Warmup Num",
          "default": 10,
          "type": "integer"
        },
        "repeat_test_num": {
          "title": "Repeat Test Num",
          "default": 20,
          "type": "integer"
        },
        "sleep_num": {
          "title": "Sleep Num",
          "default": 0,
          "type": "integer"
        }
      }
    },
    "ConfigBase": {
      "title": "ConfigBase",
      "type": "object",
      "properties": {}
    },
    "MetricGoal": {
      "title": "MetricGoal",
      "type": "object",
      "properties": {
        "type": {
          "title": "Type",
          "type": "string"
        },
        "value": {
          "title": "Value",
          "type": "number"
        }
      },
      "required": [
        "type",
        "value"
      ]
    },
    "SubMetric": {
      "title": "SubMetric",
      "type": "object",
      "properties": {
        "name": {
          "title": "Name",
          "anyOf": [
            {
              "$ref": "#/definitions/AccuracySubType"
            },
            {
              "$ref": "#/definitions/LatencyMetricConfig"
            },
            {
              "type": "string"
            }
          ]
        },
        "metric_config": {
          "$ref": "#/definitions/ConfigBase"
        },
        "priority": {
          "title": "Priority",
          "default": -1,
          "type": "integer"
        },
        "higher_is_better": {
          "title": "Higher Is Better",
          "default": false,
          "type": "boolean"
        },
        "goal": {
          "$ref": "#/definitions/MetricGoal"
        }
      },
      "required": [
        "name"
      ]
    },
    "Metric": {
      "title": "Metric",
      "type": "object",
      "properties": {
        "name": {
          "title": "Name",
          "type": "string"
        },
        "type": {
          "$ref": "#/definitions/MetricType"
        },
        "backend": {
          "title": "Backend",
          "default": "torch_metrics",
          "type": "string"
        },
        "sub_types": {
          "title": "Sub Types",
          "type": "array",
          "items": {
            "$ref": "#/definitions/SubMetric"
          }
        },
        "user_config": {
          "$ref": "#/definitions/ConfigBase"
        },
        "data_config": {
          "$ref": "#/definitions/DataConfig"
        }
      },
      "required": [
        "name",
        "type",
        "sub_types"
      ]
    },
    "OliveEvaluatorConfig": {
      "title": "OliveEvaluatorConfig",
      "type": "object",
      "properties": {
        "metrics": {
          "title": "Metrics",
          "default": [],
          "type": "array",
          "items": {
            "$ref": "#/definitions/Metric"
          }
        }
      }
    },
    "SearchStrategyConfig": {
      "title": "SearchStrategyConfig",
      "type": "object",
      "properties": {
        "execution_order": {
          "title": "Execution Order",
          "type": "string"
        },
        "search_algorithm": {
          "title": "Search Algorithm",
          "type": "string"
        },
        "search_algorithm_config": {
          "$ref": "#/definitions/ConfigBase"
        },
        "output_model_num": {
          "title": "Output Model Num",
          "type": "integer"
        },
        "stop_when_goals_met": {
          "title": "Stop When Goals Met",
          "default": false,
          "type": "boolean"
        },
        "max_iter": {
          "title": "Max Iter",
          "type": "integer"
        },
        "max_time": {
          "title": "Max Time",
          "type": "integer"
        }
      },
      "required": [
        "execution_order",
        "search_algorithm"
      ]
    },
    "PackagingType": {
      "title": "PackagingType",
      "description": "Output Artifacts type.",
      "enum": [
        "Zipfile",
        "AzureMLModels",
        "AzureMLData",
        "AzureMLDeployment"
      ],
      "type": "string"
    },
    "CommonPackagingConfig": {
      "title": "CommonPackagingConfig",
      "type": "object",
      "properties": {
        "export_in_mlflow_format": {
          "title": "Export In Mlflow Format",
          "default": false,
          "type": "boolean"
        }
      }
    },
    "PackagingConfig": {
      "title": "PackagingConfig",
      "description": "Olive output artifacts generation config.",
      "type": "object",
      "properties": {
        "type": {
          "default": "Zipfile",
          "allOf": [
            {
              "$ref": "#/definitions/PackagingType"
            }
          ]
        },
        "name": {
          "title": "Name",
          "default": "OutputModels",
          "type": "string"
        },
        "config": {
          "$ref": "#/definitions/CommonPackagingConfig"
        },
        "include_runtime_packages": {
          "title": "Include Runtime Packages",
          "default": true,
          "type": "boolean"
        },
        "include_sample_code": {
          "title": "Include Sample Code",
          "default": true,
          "type": "boolean"
        }
      }
    },
    "RunEngineConfig": {
      "title": "RunEngineConfig",
      "type": "object",
      "properties": {
        "search_strategy": {
          "title": "Search Strategy",
          "anyOf": [
            {
              "$ref": "#/definitions/SearchStrategyConfig"
            },
            {
              "type": "boolean"
            }
          ]
        },
        "host": {
          "$ref": "#/definitions/SystemConfig"
        },
        "target": {
          "$ref": "#/definitions/SystemConfig"
        },
        "evaluator": {
          "$ref": "#/definitions/OliveEvaluatorConfig"
        },
        "cache_dir": {
          "title": "Cache Dir",
          "default": ".olive-cache",
          "anyOf": [
            {
              "type": "string",
              "format": "path"
            },
            {
              "type": "string"
            }
          ]
        },
        "clean_cache": {
          "title": "Clean Cache",
          "default": false,
          "type": "boolean"
        },
        "clean_evaluation_cache": {
          "title": "Clean Evaluation Cache",
          "default": false,
          "type": "boolean"
        },
        "plot_pareto_frontier": {
          "title": "Plot Pareto Frontier",
          "default": false,
          "type": "boolean"
        },
        "evaluate_input_model": {
          "title": "Evaluate Input Model",
          "default": true,
          "type": "boolean"
        },
        "output_dir": {
          "title": "Output Dir",
          "anyOf": [
            {
              "type": "string",
              "format": "path"
            },
            {
              "type": "string"
            }
          ]
        },
        "output_name": {
          "title": "Output Name",
          "type": "string"
        },
        "packaging_config": {
          "title": "Packaging Config",
          "anyOf": [
            {
              "$ref": "#/definitions/PackagingConfig"
            },
            {
              "type": "array",
              "items": {
                "$ref": "#/definitions/PackagingConfig"
              }
            }
          ]
        },
        "log_severity_level": {
          "title": "Log Severity Level",
          "default": 1,
          "type": "integer"
        },
        "ort_log_severity_level": {
          "title": "Ort Log Severity Level",
          "default": 3,
          "type": "integer"
        },
        "ort_py_log_severity_level": {
          "title": "Ort Py Log Severity Level",
          "default": 3,
          "type": "integer"
        },
        "log_to_file": {
          "title": "Log To File",
          "default": false,
          "type": "boolean"
        }
      },
      "additionalProperties": false
    },
    "RunPassConfig": {
      "title": "RunPassConfig",
      "description": "Pass configuration for Olive workflow.\n\nThis is the configuration for a single pass in Olive workflow. It includes configurations for pass type, config,\netc.\n\nExample:\n.. code-block:: json\n\n    {\n        \"type\": \"OlivePass\",\n        \"config\": {\n            \"param1\": \"value1\",\n            \"param2\": \"value2\"\n        }\n    }",
      "type": "object",
      "properties": {
        "type": {
          "title": "Type",
          "description": "The type of the pass.",
          "type": "string"
        },
        "disable_search": {
          "title": "Disable Search",
          "description": "Whether to disable search.",
          "default": false,
          "type": "boolean"
        },
        "config": {
          "title": "Config",
          "description": "The configuration of the pass. Values for required parameters must be provided. For optional parameters, default values or searchable values (if available and search is not disabled) will be used if not provided.",
          "type": "object"
        },
        "host": {
          "title": "Host",
          "description": "Host system for the pass. If it is a string, must refer to a system config under `systems` section. If not provided, use the engine's host system.",
          "anyOf": [
            {
              "$ref": "#/definitions/SystemConfig"
            },
            {
              "type": "string"
            }
          ]
        },
        "evaluator": {
          "title": "Evaluator",
          "description": "Evaluator for the pass. If it is a string, must refer to an evaluator config under `evaluators` section. If not provided, use the engine's evaluator.",
          "anyOf": [
            {
              "$ref": "#/definitions/OliveEvaluatorConfig"
            },
            {
              "type": "string"
            }
          ]
        },
        "clean_run_cache": {
          "title": "Clean Run Cache",
          "description": "Whether to clean the run cache before running the pass. If set to True, the cache related to all runs related to this pass type will be cleaned.",
          "default": false,
          "type": "boolean"
        },
        "output_name": {
          "title": "Output Name",
          "description": "Prefix of the name of the output of this pass in the output directory. Only used when the workflow is run in no-search mode. If not provided, only the output of the last pass will be saved.",
          "type": "string"
        }
      },
      "required": [
        "type"
      ]
    },
    "Precision": {
      "title": "Precision",
      "description": "An enumeration.",
      "enum": [
        "fp32",
        "fp16",
        "int8",
        "int4"
      ],
      "type": "string"
    },
    "AutoOptimizerConfig": {
      "title": "AutoOptimizerConfig",
      "type": "object",
      "properties": {
        "opt_level": {
          "title": "Opt Level",
          "default": 0,
          "type": "integer"
        },
        "disable_auto_optimizer": {
          "title": "Disable Auto Optimizer",
          "default": false,
          "type": "boolean"
        },
        "precisions": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/Precision"
          }
        }
      }
    }
  }
}